<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o - Pizzaria do Gordo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-anim { transition: all 0.3s ease; }
        .piscando { animation: piscar 1.5s infinite; }
        @keyframes piscar { 0% { border-color: red; } 50% { border-color: transparent; } 100% { border-color: red; } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen pb-20">

    <header class="bg-gray-800 border-b border-gray-700 p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="logo.jpeg" onerror="this.src='https://placehold.co/50x50/orange/white?text=PG'" class="h-10 w-10 rounded-full border border-yellow-500">
                <div>
                    <h1 class="text-lg font-bold text-yellow-500">Pizzaria do Gordo</h1>
                    <div id="status-rede" class="text-xs text-green-500 flex items-center gap-1">‚óè Online</div>
                </div>
            </div>
            <div class="text-xs text-gray-400">Fila: <span class="font-bold text-white text-lg" id="contador-ativos">0</span></div>
        </div>
    </header>

    <div class="container mx-auto px-2 mt-4 flex gap-1 overflow-x-auto">
        <button onclick="mudarAba('ativos')" id="tab-ativos" class="flex-1 bg-gray-800 border-b-2 border-yellow-500 text-yellow-500 font-bold py-3 rounded-t text-sm min-w-[120px]">üî• Cozinha</button>
        <button onclick="mudarAba('historico')" id="tab-historico" class="flex-1 bg-gray-800/40 text-gray-400 font-medium py-3 rounded-t text-sm min-w-[120px]">üèÅ Entregues</button>
        <button onclick="mudarAba('logs')" id="tab-logs" class="flex-1 bg-gray-800/40 text-gray-400 font-medium py-3 rounded-t text-sm min-w-[120px]">üìÇ Logs/Clientes</button>
    </div>

    <div class="container mx-auto px-2 py-4">
        <div id="lista-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <p class="col-span-full text-center text-gray-500">Carregando...</p>
        </div>
    </div>

    <button onclick="baixarExcelBrasileiro()" class="fixed bottom-6 right-6 bg-green-600 hover:bg-green-500 text-white p-3 rounded-full shadow-lg z-50">
        <span class="material-icons">download</span>
    </button>

    <script>
        const SUPABASE_URL = 'https://zocvshviimdzaourupau.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_AQ1RRrRoOptDXQRu4gxnjA_kj6lN57t'; 
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let abaAtual = 'ativos';
        let dadosLocais = []; 

        function iniciarRealtime() {
            carregarBanco();
            client.channel('tabela-pedidos')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'pedidos_whatsapp' }, () => carregarBanco())
                .subscribe();
        }

        async function carregarBanco() {
            let query = client.from('pedidos_whatsapp').select('*').order('created_at', { ascending: false });
            
            // L√≥gica de Filtro do Banco para n√£o pesar
            if (abaAtual === 'ativos') {
                const ontem = new Date();
                ontem.setHours(ontem.getHours() - 24);
                query = query.gt('created_at', ontem.toISOString());
            } else if (abaAtual === 'logs') {
                query = query.limit(100); // Traz os √∫ltimos 100 logs gerais
            } else {
                query = query.limit(50); // Hist√≥rico de entregas
            }
            
            const { data } = await query;
            if (data) { dadosLocais = data; renderizar(); }
        }

        function formatarEndereco(endRaw) {
            if (!endRaw || endRaw === "N√£o informado") return "Balc√£o / A combinar";
            try {
                if (endRaw.trim().startsWith('{')) {
                    const obj = JSON.parse(endRaw);
                    return `${obj.rua || ''}, ${obj.numero || ''} - ${obj.bairro || ''} ${obj.referencia ? '('+obj.referencia+')' : ''}`.replace(/^, /, '');
                }
            } catch (e) {}
            return endRaw.replace(/{|}|"/g, '').replace(/,/g, ', ');
        }

        function renderizar() {
            const container = document.getElementById('lista-cards');
            container.innerHTML = '';
            
            const filtrados = dadosLocais.filter(item => {
                if (abaAtual === 'ativos') return item.status === 'pendente' || item.status === 'em_entrega';
                if (abaAtual === 'historico') return item.status === 'concluido';
                return true; // Logs mostra tudo (conversa, pendente, concluido)
            });

            if (abaAtual === 'ativos') {
                document.getElementById('contador-ativos').innerText = filtrados.length;
            }

            if (filtrados.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-600 py-10">Lista vazia.</div>';
                return;
            }

            filtrados.forEach(p => {
                const dataCriacao = new Date(p.created_at);
                const hora = dataCriacao.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                const dia = dataCriacao.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                
                // --- CONTE√öDO DO PEDIDO (Mostra detalhes: cebola, refri, etc) ---
                let conteudo = '';
                if (p.status === 'conversa') {
                    // Se for log de conversa, mostra o texto da mensagem
                    const textoMsg = p.itens?.mensagem || "Mensagem de texto";
                    conteudo = `<div class="text-gray-400 italic text-sm p-2 bg-gray-900/30 rounded border-l-2 border-blue-500">"${textoMsg}"</div>`;
                } else if (p.itens?.itens) {
                    p.itens.itens.forEach(i => {
                        conteudo += `<div class="flex justify-between items-start text-sm border-b border-gray-700 py-2 last:border-0">
                            <span class="font-bold text-yellow-100 whitespace-nowrap mr-2">${i.qtd}x</span> 
                            <span class="text-gray-300 leading-tight">${i.item}</span>
                        </div>`;
                    });
                }

                // Cards diferentes dependendo da aba
                const card = document.createElement('div');
                card.className = `bg-gray-800 rounded-lg p-3 shadow border border-gray-700 card-anim relative`;
                
                // Se for aba de Logs, visual √© mais compacto
                if (abaAtual === 'logs') {
                    const statusColor = p.status === 'conversa' ? 'text-gray-500' : (p.status === 'pendente' ? 'text-yellow-500' : 'text-green-500');
                    card.innerHTML = `
                        <div class="flex justify-between mb-1">
                            <span class="text-xs text-gray-500">${dia} ${hora}</span>
                            <span class="text-xs font-bold uppercase ${statusColor}">${p.status}</span>
                        </div>
                        <div class="font-bold text-white mb-1">${p.cliente_nome} <span class="text-xs text-gray-500 font-normal">(${p.whatsapp_numero.replace('@c.us','').slice(-4)})</span></div>
                        ${conteudo}
                    `;
                } else {
                    // Aba Cozinha e Hist√≥rico (Visual Completo)
                    let btn = '';
                    if (p.status === 'pendente') {
                        btn = `<button onclick="acaoOtimista('${p.id}', 'em_entrega')" class="w-full mt-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 rounded text-sm flex justify-center items-center gap-2 transition"><span class="material-icons text-sm">two_wheeler</span> SAIU</button>`;
                    } else if (p.status === 'em_entrega') {
                        btn = `<button onclick="acaoOtimista('${p.id}', 'concluido')" class="w-full mt-3 bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded text-sm flex justify-center items-center gap-2 transition"><span class="material-icons text-sm">check</span> ENTREGUE</button>`;
                    }

                    const enderecoL = formatarEndereco(p.endereco);

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-white truncate max-w-[70%]">${p.cliente_nome}</h3>
                            <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">${hora}</span>
                        </div>
                        <div class="bg-gray-900/50 p-2 rounded mb-2 min-h-[40px]">${conteudo}</div>
                        
                        ${p.status !== 'conversa' ? `
                        <div class="text-xs text-gray-300 flex items-start gap-1 mt-1 bg-gray-700/30 p-1 rounded">
                            <span class="material-icons text-[12px] mt-[2px] text-yellow-500">place</span> 
                            <span class="break-words leading-tight max-w-[90%]">${enderecoL}</span>
                        </div>` : ''}
                        
                        ${btn}
                    `;
                }
                container.appendChild(card);
            });
        }

        async function acaoOtimista(id, novoStatus) {
            let dados = { status: novoStatus };
            if (novoStatus === 'em_entrega') dados.saiu_entrega_em = new Date().toISOString();
            if (novoStatus === 'concluido') dados.concluido_em = new Date().toISOString();
            await client.from('pedidos_whatsapp').update(dados).eq('id', id);
        }

        function mudarAba(nova) {
            abaAtual = nova;
            // Estiliza√ß√£o simples dos bot√µes
            ['ativos', 'historico', 'logs'].forEach(aba => {
                const btn = document.getElementById(`tab-${aba}`);
                if (aba === nova) btn.className = "flex-1 bg-gray-800 border-b-2 border-yellow-500 text-yellow-500 font-bold py-3 rounded-t text-sm min-w-[120px]";
                else btn.className = "flex-1 bg-gray-800/40 text-gray-400 font-medium py-3 rounded-t text-sm min-w-[120px]";
            });
            carregarBanco();
        }

        async function baixarExcelBrasileiro() {
            const { data } = await client.from('pedidos_whatsapp').select('*').order('created_at', {ascending: false});
            let csv = "Data;Dia;Cliente;Telefone;Pedido;Status;Endereco\n";
            data.forEach(d => {
                let itens = "";
                if (d.itens?.itens) itens = d.itens.itens.map(i=>`${i.qtd} ${i.item}`).join(" + ");
                else if (d.itens?.mensagem) itens = `[Msg]: ${d.itens.mensagem}`;
                
                itens = itens.replace(/;/g, " ").replace(/\n/g, " ");
                let endereco = formatarEndereco(d.endereco).replace(/;/g, ","); 
                let cliente = (d.cliente_nome || "Cliente").replace(/;/g, " ");
                let tel = d.whatsapp_numero.replace('@c.us','');

                csv += `${new Date(d.created_at).toLocaleDateString('pt-BR')};${new Date(d.created_at).toLocaleDateString('pt-BR',{weekday:'long'})};${cliente};${tel};${itens};${d.status};${endereco}\n`;
            });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Relatorio_Completo_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
        }

        iniciarRealtime();
        setInterval(renderizar, 60000);
    </script>
</body>
</html>
