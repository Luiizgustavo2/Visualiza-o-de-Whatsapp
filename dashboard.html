<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzaria do Gordo | Monitor AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
        .card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .new-item-flash { animation: flash 1s; }
        @keyframes flash { 0% { background-color: #374151; } 50% { background-color: #4b5563; } 100% { background-color: #1f2937; } }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-20">

    <header class="bg-gray-800 border-b border-gray-700 h-16 flex items-center justify-between px-4 sticky top-0 z-50 shadow-2xl">
        <div class="flex items-center gap-3">
            <div class="relative">
                <div class="h-10 w-10 rounded-full bg-yellow-500 flex items-center justify-center font-bold text-gray-900 shadow-lg border-2 border-yellow-300">P</div>
                <div class="absolute -bottom-1 -right-1 h-4 w-4 bg-green-500 rounded-full border-2 border-gray-800 animate-pulse"></div>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight tracking-tight">Pizzaria do Gordo</h1>
                <div class="text-[10px] text-gray-400 font-mono uppercase tracking-widest">Sistema Neural v2.0</div>
            </div>
        </div>
        <div class="flex gap-3">
            <div class="flex flex-col items-end">
                <span class="text-[10px] text-gray-400 uppercase">Cozinha</span>
                <span id="kitchen-count" class="font-bold text-yellow-400 text-xl leading-none">0</span>
            </div>
            <div class="w-px h-8 bg-gray-700"></div>
            <div class="flex flex-col items-end">
                <span class="text-[10px] text-gray-400 uppercase">Rua</span>
                <span id="street-count" class="font-bold text-blue-400 text-xl leading-none">0</span>
            </div>
        </div>
    </header>

    <div class="flex p-2 gap-2 bg-gray-900 sticky top-16 z-40 shadow-md">
        <button onclick="switchTab('active')" id="btn-active" class="flex-1 py-3 rounded-lg font-bold text-sm bg-gray-800 text-yellow-500 border border-yellow-500/30 shadow-lg">
            üî• Pedidos Ativos
        </button>
        <button onclick="switchTab('history')" id="btn-history" class="flex-1 py-3 rounded-lg font-medium text-sm text-gray-400 hover:bg-gray-800 border border-transparent transition">
            ‚úÖ Hist√≥rico
        </button>
        <button onclick="switchTab('logs')" id="btn-logs" class="flex-1 py-3 rounded-lg font-medium text-sm text-gray-400 hover:bg-gray-800 border border-transparent transition">
            üí¨ Logs Gerais
        </button>
    </div>

    <main id="main-grid" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <div class="col-span-full py-20 text-center text-gray-500">
            <span class="material-icons text-4xl animate-spin mb-4">sync</span>
            <p>Sincronizando com o c√©rebro...</p>
        </div>
    </main>

    <div id="modal-backdrop" class="fixed inset-0 bg-black/80 hidden z-[60] flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-gray-800 w-full sm:max-w-md h-[80vh] sm:h-auto sm:max-h-[80vh] rounded-t-2xl sm:rounded-2xl shadow-2xl flex flex-col border border-gray-700">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-900/50 rounded-t-2xl">
                <div>
                    <h3 id="modal-title" class="font-bold text-white">Hist√≥rico</h3>
                    <p id="modal-subtitle" class="text-xs text-gray-400">Carregando...</p>
                </div>
                <button onclick="closeModal()" class="h-8 w-8 rounded-full hover:bg-gray-700 flex items-center justify-center text-gray-400 transition"><span class="material-icons">close</span></button>
            </div>
            <div id="modal-content" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-900 font-mono text-sm">
                </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO
        const SUPABASE_URL = 'https://zocvshviimdzaourupau.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_AQ1RRrRoOptDXQRu4gxnjA_kj6lN57t';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentTab = 'active';
        let dbData = [];

        function init() {
            refreshData();
            // Escuta TUDO: Insert, Update, Delete
            const channel = client.channel('db-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'pedidos_whatsapp' }, (payload) => {
                    console.log('üîÑ Atualiza√ß√£o detectada:', payload);
                    refreshData(); // Recarrega imediatamente ao detectar mudan√ßa
                })
                .subscribe();
        }

        async function refreshData() {
            let query = client.from('pedidos_whatsapp').select('*').order('created_at', { ascending: false });
            // Busca um pouco mais de dados para garantir que logs e pedidos apare√ßam
            query = query.limit(100);

            const { data, error } = await query;
            if (!error) {
                dbData = data;
                render();
            }
        }

        function cleanAddress(raw) {
            if (!raw || raw === "N√£o informado") return "Retirada / Balc√£o";
            try {
                if (raw.trim().startsWith('{')) {
                    const o = JSON.parse(raw);
                    return `${o.rua}, ${o.numero} - ${o.bairro}`.replace('undefined', '');
                }
            } catch (e) {}
            return raw.replace(/{|}|"/g, '').replace(/,/g, ', ');
        }

        function render() {
            const grid = document.getElementById('main-grid');
            grid.innerHTML = '';

            const filtered = dbData.filter(item => {
                if (currentTab === 'active') return (item.status === 'pendente' || item.status === 'em_entrega');
                if (currentTab === 'history') return item.status === 'concluido';
                return true; // Logs mostra tudo
            });

            const activeOrders = dbData.filter(d => d.status === 'pendente' || d.status === 'em_entrega');
            document.getElementById('kitchen-count').innerText = activeOrders.filter(d => d.status === 'pendente').length;
            document.getElementById('street-count').innerText = activeOrders.filter(d => d.status === 'em_entrega').length;

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center opacity-40"><p class="text-xl font-bold">Nada aqui</p></div>`;
                return;
            }

            filtered.forEach(item => {
                const card = document.createElement('div');
                card.className = "card bg-gray-800 rounded-xl border border-gray-700 p-4 flex flex-col relative overflow-hidden new-item-flash";
                
                const date = new Date(item.created_at);
                const timeStr = date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                const elapsed = Math.floor((new Date() - date) / 60000);
                const address = cleanAddress(item.endereco);
                
                let contentHtml = '';
                if (item.status === 'log_conversa') {
                    contentHtml = `<p class="text-gray-400 italic text-sm">"${item.itens?.mensagem || '...'}"</p>`;
                } else if (item.itens?.itens) {
                    item.itens.itens.forEach(i => {
                        contentHtml += `<div class="flex justify-between items-center py-1 border-b border-gray-700 last:border-0">
                            <span class="font-bold text-yellow-500 mr-2">${i.qtd}x</span>
                            <span class="text-gray-200 text-sm leading-tight">${i.item}</span>
                        </div>`;
                    });
                }

                let statusBadge = '';
                if(item.status === 'pendente') statusBadge = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-900 text-yellow-200 border border-yellow-700">COZINHA (${elapsed} min)</span>`;
                else if(item.status === 'em_entrega') statusBadge = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-900 text-blue-200 border border-blue-700">RUA</span>`;
                else statusBadge = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-700 text-gray-400">${item.status}</span>`;

                let actionBtn = '';
                if (item.status === 'pendente') {
                    actionBtn = `<button onclick="updateStatus('${item.id}', 'em_entrega')" class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 rounded text-xs uppercase tracking-wider transition">Saiu p/ Entrega</button>`;
                } else if (item.status === 'em_entrega') {
                    actionBtn = `<button onclick="updateStatus('${item.id}', 'concluido')" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded text-xs uppercase tracking-wider transition">Confirmar Entrega</button>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <div class="h-8 w-8 rounded bg-gray-700 flex items-center justify-center font-bold text-gray-400 text-xs">${item.cliente_nome ? item.cliente_nome[0] : '?'}</div>
                            <div>
                                <h3 class="font-bold text-white text-sm leading-tight truncate w-32">${item.cliente_nome || 'Cliente'}</h3>
                                <p class="text-[10px] text-gray-500">${item.whatsapp_numero.replace('@c.us','').slice(-4)} ‚Ä¢ ${timeStr}</p>
                            </div>
                        </div>
                        ${statusBadge}
                    </div>

                    <div class="bg-gray-900/50 rounded p-2 mb-3 flex-1 overflow-y-auto max-h-32 scrollbar-thin">
                        ${contentHtml}
                    </div>

                    ${item.status !== 'log_conversa' ? `
                    <div class="flex items-start gap-2 mb-3">
                        <span class="material-icons text-gray-500 text-sm">place</span>
                        <p class="text-xs text-gray-400 leading-tight">${address}</p>
                    </div>` : ''}

                    <div class="flex gap-2 mt-auto">
                        <button onclick="openModal('${item.whatsapp_numero}', '${item.cliente_nome}')" class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 transition" title="Ver Conversa">
                            <span class="material-icons text-sm">chat_bubble</span>
                        </button>
                        ${actionBtn}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        async function updateStatus(id, status) {
            const updates = { status: status };
            if (status === 'em_entrega') updates.saiu_entrega_em = new Date();
            if (status === 'concluido') updates.concluido_em = new Date();
            await client.from('pedidos_whatsapp').update(updates).eq('id', id);
        }

        async function openModal(phone, name) {
            const modal = document.getElementById('modal-backdrop');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-title').innerText = name;
            document.getElementById('modal-subtitle').innerText = phone.replace('@c.us','');
            
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="text-center py-10">Carregando mem√≥ria...</div>';

            // Busca hist√≥rico completo
            const { data } = await client
                .from('pedidos_whatsapp')
                .select('*')
                .eq('whatsapp_numero', phone)
                .order('created_at', { ascending: true })
                .limit(50);

            content.innerHTML = '';
            if(!data || data.length === 0) return;

            data.forEach(msg => {
                const isSystem = msg.status !== 'log_conversa';
                const div = document.createElement('div');
                div.className = `p-3 rounded-xl max-w-[90%] ${isSystem ? 'ml-auto bg-blue-900/30 border border-blue-800 text-blue-100' : 'bg-gray-700 text-gray-200'}`;
                
                let text = '';
                if(isSystem) {
                    let lista = msg.itens?.itens ? msg.itens.itens.map(i => `${i.qtd}x ${i.item}`).join(', ') : "Pedido atualizado";
                    text = `üìù <strong>Sistema (Pedido):</strong><br>${lista}`;
                } else {
                    text = msg.itens.mensagem;
                }

                div.innerHTML = `<div class="text-[10px] opacity-50 mb-1">${new Date(msg.created_at).toLocaleTimeString()}</div>${text}`;
                content.appendChild(div);
            });
            content.scrollTop = content.scrollHeight;
        }

        function closeModal() {
            document.getElementById('modal-backdrop').classList.add('hidden');
        }

        function switchTab(tab) {
            currentTab = tab;
            const btns = ['active', 'history', 'logs'];
            btns.forEach(b => {
                const el = document.getElementById(`btn-${b}`);
                if(b === tab) el.className = "flex-1 py-3 rounded-lg font-bold text-sm bg-gray-800 text-yellow-500 border border-yellow-500/30 shadow-lg";
                else el.className = "flex-1 py-3 rounded-lg font-medium text-sm text-gray-400 hover:bg-gray-800 border border-transparent transition";
            });
            render();
        }

        init();
    </script>
</body>
</html>
