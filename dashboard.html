<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o - Pizzaria do Gordo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-anim { transition: all 0.3s ease; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .piscando { animation: piscar 1.5s infinite; }
        @keyframes piscar { 0% { border-color: red; } 50% { border-color: transparent; } 100% { border-color: red; } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen pb-20">

    <header class="bg-gray-800 border-b border-gray-700 p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="logo.jpeg" onerror="this.src='https://placehold.co/50x50/orange/white?text=PG'" class="h-10 w-10 rounded-full border border-yellow-500">
                <div>
                    <h1 class="text-lg font-bold text-yellow-500">Pizzaria do Gordo</h1>
                    <div id="status-rede" class="text-xs text-green-500 flex items-center gap-1">‚óè Conectado</div>
                </div>
            </div>
            <div class="text-xs text-gray-400">
                Ativos: <span class="font-bold text-white text-lg" id="contador-ativos">0</span>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-2 mt-4 flex gap-2">
        <button onclick="mudarAba('ativos')" id="tab-ativos" class="flex-1 bg-gray-800 border-b-2 border-yellow-500 text-yellow-500 font-bold py-3 rounded-t text-sm">üî• Cozinha & Entrega</button>
        <button onclick="mudarAba('historico')" id="tab-historico" class="flex-1 bg-gray-800/40 text-gray-400 font-medium py-3 rounded-t text-sm">üìÇ Hist√≥rico</button>
    </div>

    <div class="container mx-auto px-2 py-4">
        <div id="lista-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <p class="col-span-full text-center text-gray-500 py-10">Aguardando pedidos...</p>
        </div>
    </div>

    <button onclick="baixarExcelBrasileiro()" class="fixed bottom-6 right-6 bg-green-600 hover:bg-green-500 text-white p-3 rounded-full shadow-lg z-50 transition transform hover:scale-110" title="Baixar Planilha">
        <span class="material-icons">download</span>
    </button>

    <script>
        const SUPABASE_URL = 'https://zocvshviimdzaourupau.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_AQ1RRrRoOptDXQRu4gxnjA_kj6lN57t'; 
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let abaAtual = 'ativos';
        let dadosLocais = []; 

        function iniciarRealtime() {
            client.channel('tabela-pedidos')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'pedidos_whatsapp' }, () => carregarBanco())
                .subscribe();
            carregarBanco(); 
        }

        async function carregarBanco() {
            let query = client.from('pedidos_whatsapp').select('*').order('created_at', { ascending: false });
            if (abaAtual === 'ativos') {
                const ontem = new Date();
                ontem.setHours(ontem.getHours() - 24);
                query = query.gt('created_at', ontem.toISOString());
            } else {
                query = query.limit(40);
            }
            const { data } = await query;
            if (data) { dadosLocais = data; renderizar(); }
        }

        // --- FUN√á√ÉO DE LIMPEZA DO ENDERE√áO ---
        function formatarEndereco(endRaw) {
            if (!endRaw || endRaw === "N√£o informado") return "Retirada / Balc√£o";
            
            try {
                // Tenta ler se for formato JSON (aquele cheio de chaves)
                // Se a string come√ßar com '{', provavelmente √© JSON
                if (endRaw.trim().startsWith('{')) {
                    const obj = JSON.parse(endRaw);
                    // Monta bonito: Rua tal, numero tal - Bairro tal
                    let texto = `${obj.rua || ''}, ${obj.numero || 'S/N'}`;
                    if (obj.bairro) texto += ` - ${obj.bairro}`;
                    if (obj.referencia) texto += ` (${obj.referencia})`;
                    return texto.replace(/^, /, ''); // Remove v√≠rgula do come√ßo se n√£o tiver rua
                }
            } catch (e) {
                // Se der erro ao ler JSON, ignora e segue pro tratamento de texto comum
            }

            // Se for texto normal, s√≥ limpa aspas e chaves feias se tiverem sobrado
            return endRaw.replace(/{|}|"/g, '').replace(/,/g, ', ');
        }

        function renderizar() {
            const container = document.getElementById('lista-cards');
            container.innerHTML = '';
            const filtrados = dadosLocais.filter(item => {
                if (abaAtual === 'ativos') return item.status === 'pendente' || item.status === 'em_entrega';
                return true;
            });
            document.getElementById('contador-ativos').innerText = filtrados.length;

            if (filtrados.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-600 py-10">Tudo limpo!</div>';
                return;
            }

            filtrados.forEach(p => {
                const dataCriacao = new Date(p.created_at);
                const hora = dataCriacao.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                const agora = new Date();

                // Timer
                let timerHtml = '';
                let borderClass = 'border-gray-700';

                if (p.status === 'pendente') {
                    const diff = Math.floor((agora - dataCriacao) / 60000);
                    let cor = diff > 40 ? 'text-red-500 font-bold' : (diff > 20 ? 'text-yellow-400' : 'text-green-400');
                    if (diff > 40) borderClass = 'border-red-500 piscando';
                    timerHtml = `<span class="${cor} text-xs font-bold flex items-center gap-1"><span class="material-icons text-[12px]">oven_gen</span> ${diff} min</span>`;
                } else if (p.status === 'em_entrega') {
                    const diff = p.saiu_entrega_em ? Math.floor((agora - new Date(p.saiu_entrega_em)) / 60000) : 0;
                    timerHtml = `<span class="text-blue-300 text-xs font-bold flex items-center gap-1"><span class="material-icons text-[12px]">two_wheeler</span> Rua: ${diff} min</span>`;
                    borderClass = 'border-blue-600';
                }

                // Conteudo do Pedido
                let conteudo = '';
                if (p.status === 'conversa') conteudo = '<span class="text-gray-500 italic text-sm">üí¨ Mensagem</span>';
                else if (p.itens?.itens) {
                    p.itens.itens.forEach(i => conteudo += `<div class="flex justify-between text-sm border-b border-gray-700 py-1"><span class="font-bold text-yellow-100">${i.qtd}x</span> <span class="text-gray-300 ml-2 truncate">${i.item}</span></div>`);
                }

                // Endere√ßo Limpo
                const enderecoBonito = formatarEndereco(p.endereco);

                // Bot√£o
                let btn = '';
                if (p.status === 'pendente') {
                    btn = `<button onclick="alterarStatus('${p.id}', 'em_entrega')" class="w-full mt-3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 rounded text-sm flex justify-center items-center gap-2 transition"><span class="material-icons text-sm">two_wheeler</span> SAIU</button>`;
                } else if (p.status === 'em_entrega') {
                    btn = `<button onclick="alterarStatus('${p.id}', 'concluido')" class="w-full mt-3 bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded text-sm flex justify-center items-center gap-2 transition"><span class="material-icons text-sm">check</span> ENTREGUE</button>`;
                }

                const card = document.createElement('div');
                card.className = `bg-gray-800 rounded-lg p-3 shadow border ${borderClass} card-anim relative`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-white truncate max-w-[70%]">${p.cliente_nome}</h3>
                        ${timerHtml}
                    </div>
                    <div class="bg-gray-900/50 p-2 rounded mb-2">${conteudo}</div>
                    <div class="text-xs text-gray-400 flex items-center gap-1 mb-1"><span class="material-icons text-[10px]">schedule</span> ${hora}</div>
                    
                    <div class="text-xs text-gray-300 flex items-start gap-1 mt-2 bg-gray-700/30 p-1 rounded">
                        <span class="material-icons text-[12px] mt-[2px] text-yellow-500">place</span> 
                        <span class="break-words leading-tight">${enderecoBonito}</span>
                    </div>

                    ${btn}
                `;
                container.appendChild(card);
            });
        }

        async function alterarStatus(id, novoStatus) {
            let dados = { status: novoStatus };
            if (novoStatus === 'em_entrega') dados.saiu_entrega_em = new Date().toISOString();
            if (novoStatus === 'concluido') dados.concluido_em = new Date().toISOString();
            await client.from('pedidos_whatsapp').update(dados).eq('id', id);
        }

        function mudarAba(nova) {
            abaAtual = nova;
            document.getElementById('tab-ativos').className = nova === 'ativos' ? "flex-1 bg-gray-800 border-b-2 border-yellow-500 text-yellow-500 font-bold py-3 rounded-t text-sm" : "flex-1 bg-gray-800/40 text-gray-400 font-medium py-3 rounded-t text-sm";
            document.getElementById('tab-historico').className = nova === 'historico' ? "flex-1 bg-gray-800 border-b-2 border-yellow-500 text-yellow-500 font-bold py-3 rounded-t text-sm" : "flex-1 bg-gray-800/40 text-gray-400 font-medium py-3 rounded-t text-sm";
            carregarBanco();
        }

        async function baixarExcelBrasileiro() {
            const { data } = await client.from('pedidos_whatsapp').select('*').order('created_at', {ascending: false});
            let csv = "Data;Dia;Cliente;Pedido;Status;Pagamento;Endereco\n";
            
            data.forEach(d => {
                let itens = d.itens?.itens?.map(i=>`${i.qtd} ${i.item}`).join(" + ") || "";
                itens = itens.replace(/;/g, " ").replace(/\n/g, " ");

                // Usa a mesma fun√ß√£o para limpar o endere√ßo no Excel
                let endereco = formatarEndereco(d.endereco).replace(/;/g, ","); 
                let cliente = (d.cliente_nome || "Cliente").replace(/;/g, " ");

                const dataFormatada = new Date(d.created_at).toLocaleDateString('pt-BR');
                const diaSemana = new Date(d.created_at).toLocaleDateString('pt-BR',{weekday:'long'});

                csv += `${dataFormatada};${diaSemana};${cliente};${itens};${d.status};${d.metodo_pagamento || ""};${endereco}\n`;
            });

            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Relatorio_Pizzaria_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
        }

        iniciarRealtime();
        setInterval(renderizar, 60000);
    </script>
</body>
</html>
